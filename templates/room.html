<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Room: {{ room_id }}</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        #chat { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
        #chat p { margin: 0; }
    </style>
</head>
<body>
    <h2>Room ID: {{ room_id }}</h2>
    <h3>Welcome, {{ username }}!</h3>

    <div>
        <h4>Roll Dice</h4>
        <label for="diceType">Dice:</label>
        <select id="diceType">
            <option value="4">d4</option>
            <option value="6">d6</option>
            <option value="8">d8</option>
            <option value="10">d10</option>
            <option value="12">d12</option>
            <option value="20">d20</option>
        </select>
    
        <label for="diceCount">Count:</label>
        <input type="number" id="diceCount" value="1" min="1" max="20">
    
        <button id="rollDice">Roll</button>
    </div>

    <div id="chat"></div>

    <form id="chatForm" onsubmit="return false;">
        <input type="text" id="msgInput" autocomplete="off" placeholder="Type a message..." required>
        <button type="submit">Send</button>
    </form>
    
    <div id="user-list">
        <h3>Users in Room</h3>
        <ul id="users">
            <!-- User list will be populated here -->
        </ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();

            const username = "{{ username }}";
            const room = "{{ room_id }}";
        
            // Emit join event with the username and room ID
            socket.emit('join', { username, room });
        
            const chatBox = document.getElementById('chat');
            const chatForm = document.getElementById('chatForm');
            const msgInput = document.getElementById('msgInput');
            const rollButton = document.getElementById('rollDice');
        
            // Listen for chat messages
            socket.on('chat', (data) => {
                const msg = document.createElement('p');
                msg.innerHTML = `<strong>${data.username || 'System'}:</strong> ${data.msg}`;
                chatBox.appendChild(msg);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        
            // Handle sending messages
            chatForm.addEventListener('submit', () => {
                const message = msgInput.value.trim();
                if (message) {
                    socket.emit('chat', { username, msg: message, room });
                    msgInput.value = '';
                }
            });
        
            // Handle rolling dice
            rollButton.addEventListener('click', () => {
                const sides = parseInt(document.getElementById('diceType').value);
                const count = parseInt(document.getElementById('diceCount').value);
        
                if (count > 0 && sides > 0) {
                    socket.emit('roll_dice', { username, room, sides, count });
                }
            });
        });

        // Handle before unload to disconnect user
        window.addEventListener('beforeunload', () => {
            socket.emit('disconnect_user', { username, room });
        });

        // Listen for the update_users event to update the user list in the room
        socket.on('update_users', (data) => {
            const userList = document.getElementById('users');
            userList.innerHTML = '';  // Clear the current list

            // Loop through users and add them to the list
            data.users.forEach(user => {
                const li = document.createElement('li');
                const isHost = user === data.host;  // Check if the user is the host
                li.innerHTML = isHost ? `<strong>Host: ${user}</strong>` : user;  // Highlight host
                userList.appendChild(li);
            });
        });
    </script>
</body>
</html>
