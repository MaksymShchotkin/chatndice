<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Room: {{ room_id }}</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        #chat { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
        #chat p { margin: 0; }
    </style>
</head>
<body>
    <h2>Room ID: {{ room_id }}</h2>
    <h3>Welcome, {{ username }}!</h3>

    <div>
        <h4>Roll Dice</h4>
        <label for="diceType">Dice:</label>
        <select id="diceType">
            <option value="4">d4</option>
            <option value="6">d6</option>
            <option value="8">d8</option>
            <option value="10">d10</option>
            <option value="12">d12</option>
            <option value="20">d20</option>
        </select>
    
        <label for="diceCount">Count:</label>
        <input type="number" id="diceCount" value="1" min="1" max="20">
    
        <button id="rollDice">Roll</button>
    </div>

    <div id="chat"></div>

    <form id="chatForm" onsubmit="return false;">
        <input type="text" id="msgInput" autocomplete="off" placeholder="Type a message..." required>
        <button type="submit">Send</button>
    </form>
    
    <div id="user-list">
        <h3>Users in Room</h3>
        <ul id="users">
            <!-- User list will be populated here -->
        </ul>
        <button id="leaveRoom" style="margin-top: 20px; background-color: red; color: white; padding: 8px 12px;">
            Leave Room
        </button>
    </div>

    <script>
        const socket = io();
        const username = "{{ username }}";
        const room = "{{ room_id }}";

        let hasLeft = false;
        function leaveRoom() {
            if (hasLeft) return;
            hasLeft = true;
            socket.emit('disconnect_user', { username, room });
            socket.disconnect();
            window.location.href = "/";
        }

        document.addEventListener('DOMContentLoaded', () => {
            socket.emit('join', { username, room });

            const chatBox = document.getElementById('chat');
            const chatForm = document.getElementById('chatForm');
            const msgInput = document.getElementById('msgInput');
            const rollButton = document.getElementById('rollDice');

            socket.on('chat', (data) => {
                const msg = document.createElement('p');
                msg.innerHTML = `<strong>${data.username || 'System'}:</strong> ${data.msg}`;
                chatBox.appendChild(msg);
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            document.getElementById('leaveRoom').addEventListener('click', leaveRoom);

            chatForm.addEventListener('submit', () => {
                const message = msgInput.value.trim();
                if (message) {
                    socket.emit('chat', { username, msg: message, room });
                    msgInput.value = '';
                }
            });

            rollButton.addEventListener('click', () => {
                const sides = parseInt(document.getElementById('diceType').value);
                const count = parseInt(document.getElementById('diceCount').value);

                if (count > 0 && sides > 0) {
                    socket.emit('roll_dice', { username, room, sides, count });
                }
            });
        });

        window.addEventListener('beforeunload', leaveRoom);

        socket.on('update_users', (data) => {
            const userList = document.getElementById('users');
            userList.innerHTML = '';
            data.users.forEach(user => {
                const li = document.createElement('li');
                const isHost = user === data.host;
                li.innerHTML = isHost ? `<strong>Host: ${user}</strong>` : user;
                userList.appendChild(li);
            });
        });
    </script>
</body>
</html>
